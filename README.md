# PR Reviewer Assignment Service

Сервис автоматического назначения ревьюверов на Pull Request'ы. Реализован по требованиям тестового задания Avito (осень 2025).

## Быстрый старт

```bash
make deps
make generate   # при необходимости пересобрать код из OpenAPI
make build
./bin/server
```

Либо через Docker Compose:

```bash
make docker-up
```

Сервис доступен на `http://localhost:8080`.

## Основные возможности

- Управление командами и пользователями (`/team/add`, `/team/get`, `/users/setIsActive`).
- Автономное назначение ревьюверов при создании PR (`/pullRequest/create`).
- Идемпотентное закрытие PR (`/pullRequest/merge`).
- Переназначение ревьюверов (`/pullRequest/reassign`).
- Статистика назначений ревьюверов (`/stats/reviewers`).
- Массовая деактивация команды с безопасным переназначением открытых PR (`/team/deactivate`).
- Отчёт о назначенных PR конкретного пользователя (`/users/getReview`).
- Health-check (`/health`).

## Архитектура

Проект организован внутри каталога `backend/` и следует принципам Clean Architecture.

```
backend/
├── api/               # OpenAPI-спецификация и go:generate
├── cmd/               # Точка входа приложения
├── config/            # Загрузка конфигурации
├── internal/
│   ├── adapter/       # Реализация репозиториев (PostgreSQL)
│   ├── app/           # Сборка приложения и запуск сервера
│   ├── entity/        # Доменные модели и ошибки
│   ├── input/http/    # Сгенерированный код + хендлеры
│   ├── port/          # Интерфейсы use-case'ов и репозиториев
│   ├── tests/         # Интеграционные тесты
│   └── usecase/       # Бизнес-логика
└── pkg/
    ├── client/http/   # Сгенерированный HTTP-клиент
    └── migration/     # Goose-миграции (вшиты через embed)
```

## Линтеры и тесты

- Конфигурация `golangci-lint` лежит в `.golangci.yml`.
- Запуск линтера: `make lint` (автоматически установит бинарник при необходимости).
- Юнит/интеграционные тесты: `make test`.
  - Интеграционный тест `backend/internal/tests/integration` использует Testcontainers и пропускается, если Docker недоступен.

## Нагрузочное тестирование

Сценарий и краткие результаты находятся в `docs/perf/report.md`.

## Дополнительные детали реализации

- Миграции применяются автоматически при старте через пакет `backend/pkg/migration` (goose + embed).
- Массовая деактивация поддерживает две стратегии подбора замены: `same_team` (по умолчанию) и `author_team`. При отсутствии кандидатов задействуются активные пользователи других команд; при полном отсутствии доступных ревьюверов возвращается `409` с кодом `NO_CANDIDATE`.
- Статистика отдаёт общее количество назначений и распределение по пользователям.

## Полезные команды Makefile

| Команда                  | Описание                                               |
|--------------------------|--------------------------------------------------------|
| `make deps`              | Загрузка зависимостей                                  |
| `make tools`             | Установка утилит (`oapi-codegen`, `golangci-lint`)     |
| `make generate`          | Повторная генерация кода из OpenAPI                    |
| `make build`             | Сборка бинарника в `bin/server`                        |
| `make run`               | Сборка и запуск сервера                                |
| `make test`              | Запуск тестов                                          |
| `make lint`              | Запуск линтера                                         |
| `make docker-up`         | Запуск инфраструктуры через Docker Compose             |
| `make docker-down`       | Остановка контейнеров                                  |
| `make docker-down-volumes` | Остановка и очистка volume'ов                        |
| `make clean`             | Очистка артефактов сборки                              |

## API документация

Полная спецификация: `backend/api/openapi.yaml`. Код клиента и серверных интерфейсов генерируется `oapi-codegen`.

## Конфигурация

- `POSTGRES_CONNECTION_STRING` — строка подключения к PostgreSQL (обязательная).
- `HTTP_PORT` — порт HTTP (`:8080` по умолчанию).

## Нагрузочное тестирование

Результаты и сценарий: см. [`docs/perf/report.md`](docs/perf/report.md).

## Интеграционные тесты

Интеграционный тест `TestEndToEndFlow` поднимает временный PostgreSQL через Testcontainers, выполняет полный сценарий (создание команды, PR, получение статистики, массовая деактивация). Тест автоматически пропускается, если в системе нет Docker.


